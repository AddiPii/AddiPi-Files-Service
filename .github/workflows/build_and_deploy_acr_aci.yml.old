name: Build and deploy to ACR/ACI

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Login to ACR
        run: az acr login --name ${{ secrets.ACR_NAME }}

      - name: Build and push Docker image
        env:
          DOCKER_BUILDKIT: 1
        run: |
          ACR_LOGIN_SERVER="${{ secrets.ACR_NAME }}.azurecr.io"
          IMAGE="${ACR_LOGIN_SERVER}/${{ secrets.IMAGE_NAME }}:${{ github.sha }}"
          echo "Building $IMAGE"
          docker build -t $IMAGE .
          echo "Pushing $IMAGE"
          docker push $IMAGE

      - name: Deploy to Azure Container Instances
        run: |
          ACR_LOGIN_SERVER="${{ secrets.AZURE_ACR_LOGIN_SERVER }}"
          if [ -z "$ACR_LOGIN_SERVER" ]; then
            ACR_LOGIN_SERVER="${{ secrets.ACR_NAME }}.azurecr.io"
          fi
          IMAGE="${ACR_LOGIN_SERVER}/${{ secrets.IMAGE_NAME }}:${{ github.sha }}"

          # Create container if it doesn't exist, else update by restarting (pulls new image)
          set -e
          if az container show -g "${{ secrets.ACI_RESOURCE_GROUP }}" -n "${{ secrets.ACI_NAME }}" >/dev/null 2>&1; then
            echo "Container exists â€” restarting to pick up new image"
            az container restart -g "${{ secrets.ACI_RESOURCE_GROUP }}" -n "${{ secrets.ACI_NAME }}"
          else
            echo "Creating container ${ { secrets.ACI_NAME } } in resource group ${ { secrets.ACI_RESOURCE_GROUP } }"
            az container create \
              -g "${{ secrets.ACI_RESOURCE_GROUP }}" \
              -n "${{ secrets.ACI_NAME }}" \
              --image "$IMAGE" \
              --dns-name-label "${{ secrets.ACI_DNS_NAME_LABEL }}" \
              --ports 80 5000 \
              --registry-login-server "$ACR_LOGIN_SERVER" \
              --registry-username "${{ secrets.ACR_USERNAME }}" \
              --registry-password "${{ secrets.ACR_PASSWORD }}" \
              --environment-variables STORAGE_CONN="${{ secrets.STORAGE_CONN }}" SERVICE_BUS_CONN="${{ secrets.SERVICE_BUS_CONN }}"
          fi
